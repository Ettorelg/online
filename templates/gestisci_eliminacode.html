<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestione Eliminacode</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #222;
      --muted: #6b7280;
      --primary: #0d6efd;
      --success: #198754;
      --danger: #dc3545;
      --ring: rgba(13, 110, 253, .35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text);
    }
    .container {
      max-width: 980px; margin: 0 auto; background: var(--card); border-radius: 14px; padding: 24px; box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    h1, h2, h3 { margin: 0 0 12px; line-height: 1.25; }
    h1 { font-size: 1.6rem; }
    h2 { font-size: 1.2rem; color: var(--muted); font-weight: 600; }

    .grid { display: grid; gap: 16px; }
    .section { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 16px; }

    label { display: block; font-size: .925rem; margin: 8px 0 6px; color: var(--muted); }
    input, select, button {
      width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font: inherit; outline: none; background: #fff;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring); }

    button { cursor: pointer; border: none; color: #fff; font-weight: 600; transition: transform .06s ease, filter .2s ease; }
    .btn-primary { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-blue { background: var(--primary); }
    button:hover { filter: brightness(.95); }
    button:active { transform: translateY(1px); }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; }
    thead th { position: sticky; top: 0; background: #0d6efd; color: #fff; z-index: 1; }
    tbody tr:hover { background: #f9fafb; }

    .row-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .inline-form { display: flex; gap: 8px; align-items: center; }
    .inline-form input { width: auto; min-width: 220px; }

    .switch { display: inline-flex; align-items: center; gap: 8px; font-size: .95rem; }
    .switch input[type="checkbox"] { width: 18px; height: 18px; }

    .note { color: var(--muted); font-size: .9rem; }

    @media (max-width: 720px) {
      .inline-form { flex-direction: column; align-items: stretch; }
      .inline-form input { min-width: 100%; }
      th, td { font-size: .95rem; }
    }
  </style>
</head>
<body>
  <main class="container" aria-labelledby="titolo">
    <h1 id="titolo">Gestione Eliminacode</h1>

    <!-- Aggiunta Reparto -->
    <section class="section" aria-labelledby="aggiungi-reparto">
      <h2 id="aggiungi-reparto">Aggiungi Reparto</h2>
      <form method="POST" class="grid" autocomplete="off">
        {{ csrf_token() if csrf_token is defined }}
        <div>
          <label for="nuovo_reparto">Nome Reparto</label>
          <input id="nuovo_reparto" name="nuovo_reparto" type="text" placeholder="Es. Sportello 1" required />
        </div>
        <div>
          <label for="ip_reparto">Indirizzo IP stampante (opzionale)</label>
          <input id="ip_reparto" name="ip_reparto" inputmode="numeric" pattern="^(?:\d{1,3}\.){3}\d{1,3}$" placeholder="Es. 192.168.1.50" />
          <p class="note">Accetta IPv4. La validazione completa va rifatta lato server.</p>
        </div>
        <div>
          <button class="btn-primary" type="submit" name="azione" value="aggiungi_reparto">Aggiungi Reparto</button>
        </div>
      </form>
    </section>

    <!-- Lista Reparti -->
    <section class="section" aria-labelledby="reparti-esistenti">
      <h2 id="reparti-esistenti">Reparti Esistenti</h2>
      <table role="grid" aria-describedby="hint-reparti">
        <caption class="note" id="hint-reparti">Modifica IP, visibilità, elimina reparto</caption>
        <thead>
          <tr>
            <th scope="col">Reparto</th>
            <th scope="col">Indirizzo IP</th>
            <th scope="col">Visibilità</th>
            <th scope="col" style="width: 120px;">Azioni</th>
            <th scope="col" style="width: 160px;">Visualizza Cronologia</th>
          </tr>
        </thead>
        <tbody>
        {% for reparto_id, reparto_nome, ip_address, visibile_ritira, visibile_qr in reparti %}
          <tr>
            <th scope="row">{{ reparto_nome }}</th>
            <td>
              <form method="POST" class="inline-form" autocomplete="off">
                {{ csrf_token() if csrf_token is defined }}
                <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
                <input type="text" name="nuovo_ip" value="{{ ip_address or '' }}" inputmode="numeric" pattern="^(?:\d{1,3}\.){3}\d{1,3}$" placeholder="Nessuna stampante" aria-label="Indirizzo IP per {{ reparto_nome }}" />
                <button class="btn-blue" type="submit" name="azione" value="modifica_ip">Salva</button>
              </form></td>
            <td>
              <form method="POST">
                <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
                <label class="switch">
                  <input type="checkbox" name="visualizza_cronologia" data-autosubmit data-action="modifica_cronologia" /> Cronologia
                </label>
                <input type="hidden" name="azione" value="modifica_cronologia" />
              </form>
            </td>
            <td>
              <form method="POST" class="row-actions" onsubmit="return false;">
                {{ csrf_token() if csrf_token is defined }}
                <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
                <!-- Hidden inputs ensure a value is always submitted even if checkbox is unchecked -->
                <input type="hidden" name="visibile_ritira" value="0" />
                <label class="switch">
                  <input type="checkbox" name="visibile_ritira" value="1" {% if visibile_ritira %}checked{% endif %} data-autosubmit data-action="modifica_visibilita" aria-label="Mostra 'Ritira Ticket' per {{ reparto_nome }}" />
                  Ritira Ticket
                </label>
                <input type="hidden" name="visibile_qr" value="0" />
                <label class="switch">
                  <input type="checkbox" name="visibile_qr" value="1" {% if visibile_qr %}checked{% endif %} data-autosubmit data-action="modifica_visibilita" aria-label="Mostra 'QR Code' per {{ reparto_nome }}" />
                  QR Code
                </label>
                <input type="hidden" name="azione" value="modifica_visibilita" />
              </form></td>
            <td>
              <form method="POST">
                <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
                <label class="switch">
                  <input type="checkbox" name="visualizza_cronologia" data-autosubmit data-action="modifica_cronologia" /> Cronologia
                </label>
                <input type="hidden" name="azione" value="modifica_cronologia" />
              </form>
            </td>
            <td>
              <form method="POST" onsubmit="return confirm('Eliminare definitivamente il reparto \"{{ reparto_nome }}\"? Questa azione non è reversibile.');">
                {{ csrf_token() if csrf_token is defined }}
                <input type="hidden" name="elimina_reparto" value="{{ reparto_id }}" />
                <button class="btn-danger" type="submit" name="azione" value="elimina_reparto">Elimina</button>
              </form></td>
            <td>
              <form method="POST">
                <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
                <label class="switch">
                  <input type="checkbox" name="visualizza_cronologia" data-autosubmit data-action="modifica_cronologia" /> Cronologia
                </label>
                <input type="hidden" name="azione" value="modifica_cronologia" />
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- Gestione Fila/Code -->
    <section class="section" aria-labelledby="gestisci-code">
      <h2 id="gestisci-code">Gestisci Code per Reparto</h2>

      {% for reparto_id, reparto_nome, ip_address, visibile_ritira, visibile_qr in reparti %}
        <h3 id="titolo-{{ reparto_id }}">{{ reparto_nome }}</h3>
        <table role="grid">
          <thead>
            <tr>
              <th scope="col">Fila</th>
              <th scope="col" style="width: 120px;">Azioni</th>
            </tr>
          </thead>
          <tbody>
          {% for fila_id, fila_nome in file_reparto[reparto_id] %}
            <tr>
              <td>{{ fila_nome }}</td>
              <td>
                <form method="POST" onsubmit="return confirm('Eliminare la fila \"{{ fila_nome }}\"?');">
                  {{ csrf_token() if csrf_token is defined }}
                  <input type="hidden" name="elimina_file" value="{{ fila_id }}" />
                  <button class="btn-danger" type="submit" name="azione" value="elimina_fila">Elimina</button>
                </form></td>
            <td>
              <form method="POST">
                <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
                <label class="switch">
                  <input type="checkbox" name="visualizza_cronologia" data-autosubmit data-action="modifica_cronologia" /> Cronologia
                </label>
                <input type="hidden" name="azione" value="modifica_cronologia" />
              </form>
            </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

        <form method="POST" class="inline-form" autocomplete="off" aria-labelledby="aggiungi-fila-{{ reparto_id }}">
          {{ csrf_token() if csrf_token is defined }}
          <input type="hidden" name="reparto_id" value="{{ reparto_id }}" />
          <label class="sr-only" id="aggiungi-fila-{{ reparto_id }}">Aggiungi Fila a {{ reparto_nome }}</label>
          <input type="text" name="nuova_fila" placeholder="Nome Fila" required />
          <button class="btn-primary" type="submit" name="azione" value="aggiungi_fila">Aggiungi Fila</button>
        </form>
        <hr />
      {% endfor %}
    </section>

    <p class="note"><a href="/gestisci_licenze/{{ user_id }}">Torna alla gestione licenze</a></p>
  </main>

  <script>
    // Auto-submit for visibility toggles (without leaving the page)
    document.addEventListener('change', async (e) => {
      const el = e.target;
      if (!el.matches('[data-autosubmit]')) return;

      const form = el.closest('form');
      if (!form) return;

      const fd = new FormData(form);
      // Ensure checkboxes send off values correctly even when toggled individually
      // Form already has hidden inputs with 0 defaults; the checked one will override.
      try {
        const res = await fetch(location.href, {
          method: 'POST',
          headers: { 'X-Requested-With': 'fetch' },
          body: fd
        });
        if (!res.ok) throw new Error('Errore di rete');
      } catch (err) {
        alert('Aggiornamento visibilità non riuscito. Riprova.');
        console.error(err);
      }
    });
  </script>
</body>
</html>
