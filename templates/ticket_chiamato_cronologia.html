<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ticket Chiamato â€¢ Cronologia</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;display:flex;height:100vh}
    /* Sinistra: Cronologia + Immagini (40%) */
    .left-section{display:flex;flex-direction:column;justify-content:space-between;align-items:stretch;width:40%;padding:10px;background:#222;border-right:2px solid #ffcc00}
    .history-wrapper{display:flex;flex-direction:column;width:100%;max-height:60%;overflow:hidden}
    .history-title{margin:0 0 8px 0;font-size:18px;color:#ffcc00;text-transform:uppercase;letter-spacing:.5px}
    .history-list{list-style:none;margin:0;padding:0;overflow:auto;background:rgba(255,255,255,0.06);border-radius:10px}
    .history-item{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.08)}
    .history-item:last-child{border-bottom:none}
    .history-chip{background:#ffcc00;color:#000;font-weight:bold;border-radius:8px;padding:6px 10px;min-width:58px;text-align:center}
    .history-text{display:flex;flex-direction:column}
    .history-text .reparto{font-weight:bold}
    .history-time{margin-left:auto;font-size:12px;opacity:.8;white-space:nowrap}
    /* Immagini (sotto) */
    .carousel-container{width:100%;height:100%;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center;margin-top:10px}
    .carousel-images{display:flex;transition:transform 1s ease-in-out;width:100%;height:100%}
    .carousel-images img{width:100%;height:100%;object-fit:contain;border-radius:10px}
    /* Destra: Numeri chiamati (60%) */
    .right-section{display:flex;flex-direction:column;justify-content:center;align-items:center;width:60%;padding:20px;background:#000}
    .reparti-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;width:100%;max-width:900px;padding:20px}
    .reparto-container{background:rgba(255,255,255,0.1);padding:20px;border-radius:10px;text-align:center}
    .reparto-nome{font-size:clamp(18px,3vw,30px);font-weight:bold;color:#ffcc00;text-transform:uppercase}
    .ticket-number{font-size:clamp(50px,8vw,120px);font-weight:bold;padding:20px;background:#ffcc00;color:#000;border-radius:10px;display:inline-block;min-width:150px;text-align:center;transition:transform .3s,background-color .3s}
    .highlight{animation:pulse 1s infinite alternate}
    @keyframes pulse{from{transform:scale(1);background:#ffcc00}to{transform:scale(1.2);background:#ff3300}}
    .controls{position:absolute;bottom:20px;right:20px;background:none;border:none;cursor:pointer;text-align:center}
  </style>
  <script>
    // ðŸ”Œ Socket
    var socket = io("wss://zestful-flow-pregettoonline.up.railway.app", {
      transports: ["websocket"], secure: true, reconnection: true
    });

    function formatTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
      } catch(e) { return ""; }
    }

    function appendHistoryItem(listEl, item) {
      const li = document.createElement("li");
      li.className = "history-item";
      li.innerHTML = `
        <div class="history-chip">NÂ° ${item.numero ?? "-"}</div>
        <div class="history-text">
          <span class="reparto">${item.reparto}</span>
          <span class="azione">${item.azione}</span>
        </div>
        <span class="history-time">${formatTime(item.created_at)}</span>
      `;
      listEl.prepend(li);
      // taglia lista a max 100 elementi
      while (listEl.children.length > 100) listEl.removeChild(listEl.lastChild);
    }

    async function loadHistory(limit=50) {
      const listEl = document.getElementById("historyList");
      if (!listEl) return;
      try {
        const res = await fetch(`/api/cronologia_utente?limit=${limit}`);
        const data = await res.json();
        listEl.innerHTML = "";
        data.forEach(item => appendHistoryItem(listEl, item));
      } catch (e) { console.error("Errore fetch cronologia:", e); }
    }

    function highlightNumber(el) {
      el.classList.add("highlight");
      setTimeout(() => el.classList.remove("highlight"), 5000);
    }

    // Quando arrivano numeri aggiornati, aggiorniamo i box e (opzionale) appendiamo una "chiamata" in cronologia
    socket.on("update_tickets", function(numeri) {
      for (var repartoId in numeri) {
        var ticketElement = document.getElementById("ticket-" + repartoId);
        if (ticketElement) {
          var oldNumber = ticketElement.innerText;
          var newNumber = numeri[repartoId];
          const repartoName = ticketElement.dataset.reparto;
          ticketElement.innerText = newNumber;
          if (oldNumber != newNumber) {
            highlightNumber(ticketElement);
            // Aggiungi riga cronologia lato client (non sostituisce il log server)
            const listEl = document.getElementById("historyList");
            if (listEl) {
              appendHistoryItem(listEl, {
                numero: newNumber,
                reparto: repartoName,
                azione: "chiamata",
                created_at: new Date().toISOString()
              });
            }
          }
        }
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      // Avvio: carica cronologia e avvia polling leggero (ogni 15s)
      loadHistory(50);
      setInterval(loadHistory, 15000);

      // Carosello immagini
      let currentIndex = 0;
      const images = document.querySelector(".carousel-images");
      if (images && images.children.length > 0) {
        setInterval(() => {
          currentIndex = (currentIndex + 1) % images.children.length;
          images.style.transform = `translateX(-${currentIndex * 100}%)`;
        }, 3000);
      }
    });
  </script>
</head>
<body>

  <div class="left-section">
    <div class="history-wrapper">
      <h2 class="history-title">ðŸ•˜ Cronologia Ticket Chiamati</h2>
      <ul class="history-list" id="historyList"></ul>
    </div>

    <!-- Immagini a scorrimento in basso (come nella tua pagina) -->
    <div class="carousel-container">
      <div class="carousel-images">
        {% for immagine in immagini %}
          <img src="{{ immagine }}" alt="Immagine" />
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="right-section">
    <h1>ðŸ”” Ticket Chiamati ðŸ””</h1>
    <div class="reparti-container">
      {% for reparto in reparti %}
        <div class="reparto-container">
          <div class="reparto-nome">{{ reparto[1] }}</div>
          <div class="ticket-number" id="ticket-{{ reparto[0] }}" data-reparto="{{ reparto[1] }}">
            {{ numeri_chiamati[reparto[0]] if reparto[0] in numeri_chiamati else 0 }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

</body>
</html>
